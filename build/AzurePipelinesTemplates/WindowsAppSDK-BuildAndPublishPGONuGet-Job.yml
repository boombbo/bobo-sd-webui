parameters:
  dependsOn: ''
  pgdFile: Microsoft.WindowsAppSDK.pgd
  pgoArtifact: PGO

jobs:
- job: BuildAndPublishPGONuGet
  dependsOn: ${{ parameters.dependsOn }}
  pool:
    vmImage: 'windows-2019'
  variables:
    artifactsPath: $(Build.SourcesDirectory)\Artifacts
    pgoToolsPath: $(Build.SourcesDirectory)\tools\WindowsAppSDKPGODatabase
    nuspecPath: $(pgoToolsPath)\NuSpecs
    nuspecFilename: PGO.nuspec

  steps:
  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: ${{ parameters.pgoArtifact }}
      downloadPath: $(artifactsPath)

  - task: CopyFiles@2
    displayName: 'Copy pgd files to NuGet build directory'
    inputs:
      sourceFolder: $(artifactsPath)\${{ parameters.pgoArtifact }}
      contents: '**\${{ parameters.pgdFile }}'
      targetFolder: $(nuspecPath)\tools

  - task: powershell@2
    displayName: 'Generate NuSpec file'
    inputs:
      targetType: filePath
      filePath: $(pgoToolsPath)\generate-nuspec.ps1
      workingDirectory: $(pgoToolsPath)
      arguments: $(nuspecPath)\$(nuspecFilename).template $(nuspecPath)\$(nuspecFilename)

  - task: CmdLine@1
    displayName: 'Build NuGet package'
    inputs:
      filename: '$(Build.SourcesDirectory)\tools\NugetWrapper.cmd'
      arguments: pack "$(nuspecPath)\$(nuspecFilename)" -BasePath "$(nuspecPath)" -OutputDirectory "$(Build.ArtifactStagingDirectory)" -properties PROGRAMFILES="%ProgramFiles(x86)%"

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: $(Build.ArtifactStagingDirectory)
      artifactName: ${{ parameters.pgoArtifact }}

#UNDONE - these were generated by uuidgen, this is probably incorrect, probably need these fed from the VS tools
  - task: 7e925264-3315-4e78-8db2-0d4619c4f850@2
    displayName: 'NuGet push'
    inputs:
      command: push
      publishVstsFeed: b7ec28d9-64f7-41e0-9634-5d7596d43198/87a232d5-b9d7-4664-961d-61ab5cc22aa8
      packagesToPush: $(Build.ArtifactStagingDirectory)/*.nupkg
